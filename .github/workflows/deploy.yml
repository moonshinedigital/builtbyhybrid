name: ğŸš€ Deploy on push

on:
    push:
        branches:
            - main

    # Enables manually triggering of Workflow with file synchronization option
    workflow_dispatch:
        inputs:
            sync:
                description: 'File synchronization mode'
                required: true
                default: 'delta'

jobs:
    build-files:
        name: ğŸ—ï¸ Build
        runs-on: ubuntu-latest

        steps:
            - name: ğŸšš Get latest code
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Use Node.js 16
              uses: actions/setup-node@v2
              with:
                  node-version: '16'

            - name: ğŸ”¨ Build Project
              run: |
                  npm install
                  npm run build

    deploy:
        name: ğŸ‰ Deploy
        runs-on: ubuntu-latest

        needs: build-files

        steps:
            - name: ğŸ“‚ Sync files
              uses: milanmk/actions-file-deployer@master
              with:
                  remote-protocol: 'sftp'
                  remote-host: ${{ secrets.SERVER }}
                  remote-user: ${{ secrets.USERNAME }}
                  ssh-private-key: ${{ secrets.KEY }}
                  remote-path: '/public_html/app/themes/moonbase'
                  sync-delta-excludes: '/*'
